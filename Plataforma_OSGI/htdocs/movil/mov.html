<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <link rel="shortcut icon" href="../images/favio.ico" type="image/x-icon" />
        <link rel="icon" href="../images/favio.ico" type="image/x-icon">
        <title>Web of Things Dashboard</title>
		<link href="../fixed.css" rel="stylesheet" type="text/css">
		
		<script type="text/javascript" src="js/common.js"></script>
        <script type="text/javascript" src="js/constants.js"></script>
		
		<script type="text/javascript" src="./gesture/glMatrix-0.9.5.min.js"></script>
		<script type="text/javascript" src="./gesture/webgl-utils.js"></script>

		
		<script id="shader-fs" type="x-shader/x-fragment">
			#ifdef GL_ES
			precision highp float;
			#endif
		
			varying vec2 vTextureCoord;
		
			uniform sampler2D uSampler;
		
			void main(void) {
				gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
			}
		</script>

		<script id="shader-vs" type="x-shader/x-vertex">
			attribute vec3 aVertexPosition;
			attribute vec2 aTextureCoord;
		
			uniform mat4 uMVMatrix;
			uniform mat4 uPMatrix;
		
			varying vec2 vTextureCoord;
		
		
			void main(void) {
				gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
				vTextureCoord = aTextureCoord;
			}
		</script>
		
        <script type="text/javascript">
		
		    var gl;
	
			function initGL(canvas) {
				try {
					gl = canvas.getContext("experimental-webgl");
					gl.viewportWidth = canvas.width;
					gl.viewportHeight = canvas.height;
				} catch (e) {
				}
				if (!gl) {
					alert("Could not initialise WebGL, sorry :-(");
				}
			}
		
		
			function getShader(gl, id) {
		
				var shaderScript = document.getElementById(id);
				if (!shaderScript) {
					return null;
				}
		
				var str = "";
				var k = shaderScript.firstChild;
				while (k) {
					if (k.nodeType == 3) {
						str += k.textContent;
					}
					k = k.nextSibling;
				}
		
				var shader;
				if (shaderScript.type == "x-shader/x-fragment") {
					shader = gl.createShader(gl.FRAGMENT_SHADER);
				} else if (shaderScript.type == "x-shader/x-vertex") {
					shader = gl.createShader(gl.VERTEX_SHADER);
				} else {
					return null;
				}
		
				gl.shaderSource(shader, str);
				gl.compileShader(shader);
		
				if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
					alert(gl.getShaderInfoLog(shader));
					return null;
				}
		
				return shader;
			}
		
		
			var shaderProgram;
		
			function initShaders() {
				var fragmentShader = getShader(gl, "shader-fs");
				var vertexShader = getShader(gl, "shader-vs");
		
				shaderProgram = gl.createProgram();
				gl.attachShader(shaderProgram, vertexShader);
				gl.attachShader(shaderProgram, fragmentShader);
				gl.linkProgram(shaderProgram);
		
				if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
		
					alert("Could not initialise shaders");
				}
		
				gl.useProgram(shaderProgram);
		
				shaderProgram.vertexPositionAttribute = gl.getAttribLocation(shaderProgram, "aVertexPosition");
				gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute);
		
				shaderProgram.textureCoordAttribute = gl.getAttribLocation(shaderProgram, "aTextureCoord");
				gl.enableVertexAttribArray(shaderProgram.textureCoordAttribute);
		
				shaderProgram.pMatrixUniform = gl.getUniformLocation(shaderProgram, "uPMatrix");
				shaderProgram.mvMatrixUniform = gl.getUniformLocation(shaderProgram, "uMVMatrix");
				shaderProgram.samplerUniform = gl.getUniformLocation(shaderProgram, "uSampler");
			}
		
		
			function handleLoadedTexture(textures) {
				gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
		
				gl.bindTexture(gl.TEXTURE_2D, textures[0]);
				gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, textures[0].image);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
		
				gl.bindTexture(gl.TEXTURE_2D, textures[1]);
				gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, textures[1].image);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
		
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
		
				gl.bindTexture(gl.TEXTURE_2D, textures[2]);
				gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, textures[2].image);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
				gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);
				gl.generateMipmap(gl.TEXTURE_2D);
		
				gl.bindTexture(gl.TEXTURE_2D, null);
			}
		
		
			var crateTextures = Array();
		
			function initTexture() {
				var crateImage = new Image();
		
				for (var i=0; i < 3; i++) {
					var texture = gl.createTexture();
					texture.image = crateImage;
					crateTextures.push(texture);
				}
		
				crateImage.onload = function () {
					handleLoadedTexture(crateTextures)
				}
				crateImage.src = "./gesture/phone.jpg";
			}
		
		
			var mvMatrix = mat4.create();
			var mvMatrixStack = [];
			var pMatrix = mat4.create();
		
			function mvPushMatrix() {
				var copy = mat4.create();
				mat4.set(mvMatrix, copy);
				mvMatrixStack.push(copy);
			}
		
			function mvPopMatrix() {
				if (mvMatrixStack.length == 0) {
					throw "Invalid popMatrix!";
				}
				mvMatrix = mvMatrixStack.pop();
		
			}
		
		
			function setMatrixUniforms() {
				gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pMatrix);
				gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
				
			}
		
		
			function degToRad(degrees) {
				return degrees * Math.PI / 180;
			}
		
			var xRot = 0;
			var yRot = 0;
			var zRot = 0;
			var z = -5.0;
		
			var filter = 0;
		
		
			var currentlyPressedKeys = {};
		
			function handleKeyDown(event) {
				currentlyPressedKeys[event.keyCode] = true;
		
				if (String.fromCharCode(event.keyCode) == "F") {
					filter += 1;
					if (filter == 3) {
						filter = 0;
					}
				}
			}
		
		
			function handleKeyUp(event) {
				currentlyPressedKeys[event.keyCode] = false;
			}
		
			var j=0;
			var i=0;
			var xnum=0;
			var ynum=0;
			var znum=0;
			
			var xTurn=0;
			var yTurn=0;
			var zTurn=0;
			
			function handleKeys() {
				
		
				if (currentlyPressedKeys[16]) {
					// shift
					z -= 0.05;
				}
				if (currentlyPressedKeys[17]) {
					// ctrl
					z += 0.05;
				}
				if (currentlyPressedKeys[37]) {
					// Left cursor key
					zRot=-1;
					i=-j;
					znum-=1;
				}
				if (currentlyPressedKeys[39]) {
					// Right cursor key
					
					zRot=1;
					i=-j;
					znum+=1;
				}
		
				if (currentlyPressedKeys[33]) {
					//page up
					yRot=-1;
					i=-j;
					ynum-=1;
				}
				if (currentlyPressedKeys[34]) {
					// page down
					yRot=1;
					i=-j;
					ynum+=1;
				}
				if (currentlyPressedKeys[38]) {
					// Up cursor key
					xRot=-1;
					i=-j;
					xnum-=1;
				}
				if (currentlyPressedKeys[40]) {
					// Down cursor key
					xRot=1;
					i=-j;
					xnum+=1;
				 }
				if (currentlyPressedKeys[27]) {
				   //ESC key
				   xRot=0;
				   yRot=0;
				   zRot=0;
				   xnum=0;ynum=0;znum=0;i=0;
				 }
				if (currentlyPressedKeys[49]){
				 //number 1
				 j=45; 
				 }
				if (currentlyPressedKeys[50]){
				 //number 2
				 j=90;
				}
			 
			}
		
		
			var cubeVertexPositionBuffer;
			var cubeVertexTextureCoordBuffer;
			var cubeVertexIndexBuffer;
			function initBuffers() {
				cubeVertexPositionBuffer = gl.createBuffer();
				gl.bindBuffer(gl.ARRAY_BUFFER, cubeVertexPositionBuffer);
				  vertices = [
			   // Front face
					-0.5,  -0.05,  1.0,
					 0.5,  -0.05,  1.0,
					 0.5,  0.05,  1.0,
					-0.5,  0.05,  1.0,
		
					// Back face
					-0.5, -0.05, -1.0,
					-0.5, 0.05, -1.0,
					 0.5,  0.05, -1.0,
					 0.5, -0.05, -1.0,
		
					// Top face
					 -0.5,  0.05,  1.0,
					 0.5,  0.05,  1.0,
					0.5,  0.05, -1.0,
					-0.5, 0.05, -1.0,
		
					// Bottom face
					-0.5,  -0.05,  1.0,
					 -0.5, -0.05, -1.0,
					0.5, -0.05, -1.0,
					 0.5,  -0.05,  1.0,
		
					// Right face
					  0.5,  -0.05,  1.0,
					 0.5, -0.05, -1.0,
					 0.5,  0.05, -1.0,
					 0.5,  0.05,  1.0,
		
					// Left face
					 -0.5,  -0.05,  1.0,
				   -0.5,  0.05,  1.0,
					-0.5, 0.05, -1.0,
					 -0.5, -0.05, -1.0,
				];
				gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
		
				cubeVertexPositionBuffer.itemSize = 3;
				cubeVertexPositionBuffer.numItems = 24;
		
				cubeVertexTextureCoordBuffer = gl.createBuffer();
				gl.bindBuffer(gl.ARRAY_BUFFER, cubeVertexTextureCoordBuffer);
				var textureCoords = [
				   // Front face
				  0.2, 0.05,
				  0.2, 0.05,
				  0.2, 0.05,
				  0.2, 0.05,
		
				  // Back face
				  0.2, 0.05,
				  0.2, 0.05,
				  0.2, 0.05,
				  0.2, 0.05,
		
				  // Top face
				  0.0, 0.0,
				  0.48, 0.0,
				  0.48, 1.0,
				  0.0, 1.0,
		
				  // Bottom face
				  0.52, 0.0,
				  0.52, 1.0,
				  1.0, 1.0,
				  1.0, 0.0,
		
				  // Right face
				  0.2, 0.05,
				  0.2, 0.05,
				  0.2, 0.05,
				  0.2, 0.05,
		
				  // Left face
				  0.2, 0.05,
				  0.2, 0.05,
				  0.2, 0.05,
				  0.2, 0.05,
				];
				gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(textureCoords), gl.STATIC_DRAW);
				cubeVertexTextureCoordBuffer.itemSize = 2;
				cubeVertexTextureCoordBuffer.numItems = 24;
		
				cubeVertexIndexBuffer = gl.createBuffer();
				gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, cubeVertexIndexBuffer);
				var cubeVertexIndices = [
					0, 1, 2,      0, 2, 3,    // Front face
		
					4, 5, 6,      4, 6, 7,    // Back face
					8, 9, 10,     8, 10, 11,  // Top face
					12, 13, 14,   12, 14, 15, // Bottom face
					16, 17, 18,   16, 18, 19, // Right face
					20, 21, 22,   20, 22, 23  // Left face
				]
				gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(cubeVertexIndices), gl.STATIC_DRAW);
				cubeVertexIndexBuffer.itemSize = 1;
				cubeVertexIndexBuffer.numItems = 36;
			}
		
		
			function drawScene() {
				gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
				gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		
				mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0, pMatrix);
		
			  
				
			   <!-- mat4.rotate(mvMatrix, degToRad(xnum*j+xRot*i), [1, 0, 0]);-->
				<!--mat4.rotate(mvMatrix, degToRad(ynum*j+yRot*i), [0, 1, 0]);-->
				<!--mat4.rotate(mvMatrix, degToRad(znum*j+zRot*i), [0, 0, 1]);-->
			
		
				mat4.rotate(mvMatrix, degToRad(xTurn), [1, 0, 0]);
				mat4.rotate(mvMatrix, degToRad(yTurn), [0, 1, 0]);
				mat4.rotate(mvMatrix, degToRad(zTurn), [0, 0, 1]);
				
					
				
				gl.bindBuffer(gl.ARRAY_BUFFER, cubeVertexPositionBuffer);
				gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, cubeVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
		
				gl.bindBuffer(gl.ARRAY_BUFFER, cubeVertexTextureCoordBuffer);
				gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, cubeVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);
		
		
		
				gl.activeTexture(gl.TEXTURE0);
				gl.bindTexture(gl.TEXTURE_2D, crateTextures[filter]);
				gl.uniform1i(shaderProgram.samplerUniform, 0);
		
				gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, cubeVertexIndexBuffer);
				setMatrixUniforms();
				gl.drawElements(gl.TRIANGLES, cubeVertexIndexBuffer.numItems, gl.UNSIGNED_SHORT, 0);
				
			}
			function tick() {
				<!-- requestAnimFrame(tick); -->
			   <!-- handleKeys();-->
				drawScene();
				if(i<=0)
				i+=1.5;
				else {
				 i=0;xRot=0;yRot=0;zRot=0;
				 }
			}
		 
		
			function webGLStart() {
				
			 if(desactivado == 1){
					
				var texto = document.getElementById("targetDiv");		
				var canvas = document.getElementById("lesson06-canvas");
				texto.innerHTML = "<b> Esperando movimiento del Movil <b>";
												
				initGL(canvas);
				initShaders();
				initBuffers();
				initTexture();
		
				gl.clearColor(1.0, 1.0, 0.0, 1.0);
				gl.enable(gl.DEPTH_TEST);
		
				document.onkeydown = handleKeyDown;
				document.onkeyup = handleKeyUp;
				mat4.identity(mvMatrix);
				mat4.translate(mvMatrix, [0.0, 0.0, z]);
				mat4.rotate(mvMatrix, degToRad(90),[1,0,0]);
						
			   tick();
			 }
			}
		
		</script>
		
           
			
        </script>
		
		    <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
        try {
            var pageTracker = _gat._getTracker("UA-2240015-5");
            pageTracker._trackPageview();
        } catch(err) {
        }
    </script>

	<script type="text/javascript">

	  var url ="http://10.1.10.227:6008/gw-d205/mobile/1/sensor/mov";
	  var i = 0;
	  var obj;
	  var turn="";
	  var pos="";
	  var desactivado=1;
		j = 45;
		
	  function movSensorReq(){
				  
				  var http_request;				  
				  var XMLHttpRequestObject = false;
				  
				  var texto = document.getElementById("targetDiv");
				  
					if (window.XMLHttpRequest) {
					
							http_request = new XMLHttpRequest();
					
					  } else if (window.ActiveXObject) {
					
							http_request = new ActiveXObject("Microsoft.XMLHTTP");
					
					  }
					  
					http_request.open("GET",url, true);
														  
					http_request.onreadystatechange = function(){
					
						if (http_request.readyState == 4) {
						if (http_request.status == 200 && desactivado == 0) {
						 
							var obj = eval('('+http_request.responseText+')'); 
							
							if (pos != obj.pos){
							
								if(obj.turn == "x_pos"){
										
									xTurn=45;
									yTurn = 0;
									zTurn = 0;
								}else if (obj.turn =="x_neg"){
									yTurn = 0;
									zTurn = 0;	
									xTurn=-45;
								}else if(obj.turn == "y_pos"){
									yTurn = 0;
									xTurn = 0;
									zTurn=-45;
								}else if(obj.turn == "y_neg"){
									yTurn = 0;
									xTurn = 0;
									zTurn=45;
								}else if(obj.turn == "z_pos"){
									xTurn = 0;
									zTurn = 0;		
									yTurn=45;
								}else if(obj.turn == "z_neg"){
									xTurn = 0;
									zTurn = 0;	
									yTurn=-45;
								}
								
							
								if (xTurn == 360||xTurn ==-360){
									xTurn=0;
								}
								
								if (xTurn<0){
									xTurn+=360;
								}
								
								if (yTurn == 360||yTurn ==-360){
									yTurn=0;
								}
								
								if (yTurn<0){
									yTurn+=360;
								}
								
								if (zTurn == 360||zTurn ==-360){
									zTurn=0;
								}
								
								if (zTurn<0){
									zTurn+=360;
								}
								
								drawScene();
								   if(i<=0){
									i+=1.5;
									}else {
									i=0;xRot=0;yRot=0;zRot=0;
									}
								
							}
							
							document.getElementById("updatetime").innerHTML = getCompactCurrentTimestamp();
							texto.innerHTML = "<b>Estado Sensor Movimiento</b></br>Position: <b>" + obj.pos+"</b></br>Turn: <b>"+obj.turn+"</b>";
								
								i++;
														
							setTimeout(movSensorReq, 500);
							
						} else {
						
						
						 desactivarMov();
						  
						} 
						
						http_request = null;
					  }
				  }
				  
				  http_request.send(null);
				  
				  
				}
					
	
				function activarMov() {
								
					desactivado = 0;
					document.getElementById("starttime").innerHTML = getCompactCurrentTimestamp();
					drawScene();
					movSensorReq();
					
				}
				
				function desactivarMov() {
				
					
				 if(desactivado == 0){
				 
					var http_request2;
					desactivado = 1;
					
					var texto = document.getElementById("targetDiv");
					
										
					if (window.XMLHttpRequest) {
					
							http_request2 = new XMLHttpRequest();
					
					} else if (window.ActiveXObject) {
					
							http_request2 = new ActiveXObject("Microsoft.XMLHTTP");
					
					  }
							
					 http_request2.open("PUT",url,true);
					 
					 http_request2.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
					 
					 var message = {"stopMov":"stop"};
			  
					 http_request2.send(JSON.stringify(message));
					
					 texto.innerHTML = "<p>Monitorización del sensor de movimiento <b>desactivada</b></p>";
					 
					 if (http_request2.readyState == 4) {
						if (http_request2.status == 200) {
																
						} else {
						  alert("PUT Ocurrio un problema con la URL. Status ="+http_request2.status);
						}
						http_request2 = null;
					}
				 }			  				
			  
				}
				
					
				
				
	    </script>


		
		<link rel="stylesheet" href="css/example.css" TYPE="text/css" MEDIA="screen">
        <link rel="stylesheet" href="css/example-print.css" TYPE="text/css" 
              MEDIA="print">
       
		    
    </head>
    <body id ="home" onLoad="webGLStart()" onUnload="desactivarMov()">
        <div id="container">
            <table width="100%" border="0" cellspacing="0" cellpadding="0" id="layout">
                <tr>
					<td colspan="15" id="header"><div class="rigth">
					<div class="divider"><img src="../images/logo_thofu.gif" width="150" height="90">
					<img src="../images/UPM_logo.gif" width="90" height="80"></div>
					  
					<h1>Plataforma de Adquisición </h1>
				</div></td>
				</tr>
                <tr>
                    <td id="nav">
                        <ul>
                            <li><a href="../index.html">Home</a></li>
							<li><hr align="center"></li>
                            <li><b>Monitorización Ambiental</b><i>
							<li><a href="../ambiental/index_micaz.html">Monitorización micaz</a></li>
							<li><a href="../ambiental/index_sunspot.html">Monitorización Sun SPOT</a></li>
							<li><hr align="center"></li>
							<li><b>Monitorización Móvil</b><i>
							<li><a href="../movil/monitor.html">Lectura RFID</a></li>
							<li><a href="../movil/loc.html">Localización</a></li>
							<li>Sensor Movimiento</li>
							<li><hr align="center"></li>
							<li><a href="../bio/index.html"><b>Monitorización Biométrica</b></a></li>
							<li><hr align="center"></li>
							<li><b>Actuadores</b></li>
							<li><a href="../arduino/arduino_leds.html">Arduino</li>
							<li><hr align="center"></li>
							<br>
							<li><a href="../contact.html">Contáctanos</a></li>
                        </ul>
                    </td>
                    <td id="content">
                        <h2>Monitorización de movimiento de terminal </h2>
                        Comienzo: <span id="starttime"></span>, 
                        Actualizado: <span id="updatetime"></span> 
                        <br/>
						<br/>
						<br/>
                        <span style="float: right">
                          
                        </span>
                        <div> 
						
					   </div>
					   
					   <div width="200" align="center">
							<form>

								<input type = "button" value ="Activar Monitorizacion" onclick = "activarMov()">
								<input type = "button" value ="Desactivar Monitorizacion" onclick = "desactivarMov()">
							
							</form>
                        
						<div id="statusEvento" width="400">
						
							<canvas id="lesson06-canvas" style="border: none;" width="600" height="500"></canvas>
							
						</div>
						
						<div align="center" style="width:30%;background-color:#99FF66" id="targetDiv">
								<p>Monitorización del sensor de movimiento <b>desactivada</b></p>
						</div>
						
                       <!--
                        <a href="WoTViz/WoTVisualizationDemo.html">New Plots</a>
                        -->
                    </td>
                </tr>
                <tr>
                    <td colspan="3" frameborder=0 id="footer"><p>&copy;2012 Grupo de Procesado de Datos y Simulación. <img src="../images/logo_gpds.jpg" width="40" height="23"> - <a href="../contact.html">Contactar</a>
                </tr>
            </table>
        </div>
    </body>
</html>
